<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拉比的工具箱</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans TC', sans-serif; background: #f9fafb; min-height: 100vh; padding: 24px; }
        .container { max-width: 896px; margin: 0 auto; }
        header { margin-bottom: 32px; text-align: center; }
        h1 { font-size: 1.875rem; font-weight: 700; color: #1f2937; margin-bottom: 8px; }
        header p { color: #4b5563; }
        .grid { display: grid; gap: 24px; }
        @media (min-width: 768px) { .grid { grid-template-columns: 1fr 2fr; } }
        .card { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .card h2 { font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 16px; }
        .upload-area { border: 2px dashed #d1d5db; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; min-height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: border-color 0.2s; }
        .upload-area:hover { border-color: #3b82f6; }
        .upload-area svg { width: 32px; height: 32px; color: #9ca3af; margin-bottom: 8px; }
        .upload-area p { font-size: 0.75rem; color: #4b5563; }
        input[type="file"] { display: none; }
        select { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; font-size: 0.875rem; }
        label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px; }
        .avatar-upload { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; }
        .avatar-preview { width: 48px; height: 48px; border-radius: 50%; border: 1px solid #d1d5db; background-size: cover; background-position: center; }
        .btn-upload { padding: 4px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-size: 0.875rem; cursor: pointer; }
        .btn-upload:hover { background: #2563eb; }
        .slider-container { display: flex; align-items: center; gap: 8px; }
        .slider-container span { font-size: 0.75rem; color: #6b7280; }
        input[type="range"] { flex: 1; height: 8px; background: #e5e7eb; border-radius: 4px; outline: none; padding: 0; }
        .btn-download { width: 100%; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; }
        .btn-download:hover { background: #2563eb; }
        .preview-container { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
        .browser-bar { background: #f3f4f6; padding: 8px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 4px; }
        .browser-dot { width: 12px; height: 12px; border-radius: 50%; }
        .browser-dot:nth-child(1) { background: #ef4444; }
        .browser-dot:nth-child(2) { background: #eab308; }
        .browser-dot:nth-child(3) { background: #22c55e; }
        .preview-frame { width: 100%; height: 685px; border: none; background: white; }
        .preview-hint { font-size: 0.875rem; color: #6b7280; margin-bottom: 8px; }
        footer { margin-top: 48px; text-align: center; font-size: 0.875rem; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>拉比的工具箱</h1>
            <p>上傳文字檔案，套用樣式，轉換為美化 HTML</p>
        </header>
        <div class="grid">
            <div style="display:flex;flex-direction:column;gap:24px">
                <div class="card">
                    <h2>上傳文件</h2>
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p id="uploadText">點擊以選取 .txt 文件</p>
                        <input type="file" id="fileInput" accept=".txt">
                    </div>
                </div>
                <div class="card">
                    <h2>選擇聊天室主題</h2>
                    <select id="themeSelect">
                        <option value="basic">基礎</option>
                        <option value="black">黑色</option>
                        <option value="brown">棕色</option>
                        <option value="green">綠色</option>
                    </select>
                </div>
                <div class="card">
                    <h2>選擇頭像</h2>
                    <div>
                        <label>角色 頭像</label>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="charAvatar"></div>
                            <button class="btn-upload" onclick="document.getElementById('charAvatarInput').click()">上傳圖片</button>
                            <input type="file" id="charAvatarInput" accept="image/*">
                        </div>
                        <label>玩家 頭像</label>
                        <div class="avatar-upload">
                            <div class="avatar-preview" id="pcAvatar"></div>
                            <button class="btn-upload" onclick="document.getElementById('pcAvatarInput').click()">上傳圖片</button>
                            <input type="file" id="pcAvatarInput" accept="image/*">
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>調整訊息寬度</h2>
                    <div class="slider-container">
                        <span>280px</span>
                        <input type="range" id="widthSlider" min="280" max="400" step="5" value="280">
                        <span>400px</span>
                    </div>
                </div>
                <div class="card">
                    <button class="btn-download" id="downloadBtn">下載 HTML 文件</button>
                </div>
            </div>
            <div class="card">
                <h2>預覽</h2>
                <p class="preview-hint">（預覽畫面僅顯示前 40 則訊息，可滾動查看內容）</p>
                <div class="preview-container">
                    <div class="browser-bar">
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                    </div>
                    <iframe id="previewFrame" class="preview-frame"></iframe>
                </div>
            </div>
        </div>
        <footer style="margin-top: 15px; text-align: center; font-size: 12px; color: #888; border-top: 1px dotted #ccc; padding-top: 5px; line-height: 1.8;">
          <p>優化WORD轉TXT編碼(BOM)相容性</p>
          <p>修改來源─<a href="https://loveydovey-chat-converter.vercel.app/" target="_blank" style="color: #666; text-decoration: underline;">拉比的工具箱 © 2025</a></p></footer>
    </div>
    <script>
        const defaultAvatar = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZTBlMGUwIiBkPSJNMjU2IDUxMmMxNDEuNCAwIDI1Ni0xMTQuNiAyNTYtMjU2UzM5Ny40IDAgMjU2IDBTMCAxMTQuNiAwIDI1NnMxMTQuNiAyNTYgMjU2IDI1NnoiLz48cGF0aCBmaWxsPSIjYWFhIiBkPSJNMjU2IDI4OGMtNTMgMC05Ni00My05Ni05NnM0My05NiA5Ni05NnM5NiA0MyA5NiA5Ni00MyA5Ni05NiA5NnptMCAxMjhjLTEwNSAwLTE5Mi03MS0xOTItMTU5LjggMC0zMC4yIDEwLjgtNTguNyAzMC40LTgxLjZDMTI2LjIgMTM3LjE4IDE4Ny44IDExMiAyNTYgMTEyczEyOS44IDI1LjE4IDE2MS42IDYyLjZjMTkuNiAyMi45IDMwLjQgNTEuNCAzMC40IDgxLjZDNDQ4IDM0NSAzNjEgNDE2IDI1NiA0MTZ6Ii8+PC9zdmc+";
        
        let parsedData = null, charAvatarData = defaultAvatar, pcAvatarData = defaultAvatar, msgWidth = 280, uploadedFile = null;

        const themes = {
            basic: { css: `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap');body{font-family:'Noto Sans TC','Helvetica Neue',Arial,sans-serif;line-height:1.6;margin:0;padding:0;background-color:#FFF5F8;color:#333}.chat-container{max-width:500px;margin:0 auto;padding:10px}.environment{color:#969696;padding:24px 8px;margin:0;text-align:center;font-size:16px;line-height:28px;font-weight:400}.environment .stars{display:block}.date-divider{font-size:12px;color:#888;text-align:center;margin:10px 0}.char{display:flex;align-items:flex-start;margin-bottom:15px}.avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0;background-size:cover;background-position:center;background-repeat:no-repeat}.msg-container{display:flex;flex-direction:column;max-width:--MSG-WIDTH--px;margin:0 10px}.character-name{font-size:14px;margin-bottom:4px;color:#888}.char .msg-content{background-color:#FFF;color:#333;padding:8px 12px;border-radius:4px 16px 16px 16px;font-size:15px;font-weight:400}.char .msg-content em{color:#969696}blockquote{border-left:3px solid #969696;padding-left:.5em;margin:0}table{width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid #969696;margin:10px 0}th,td{text-align:left;padding:8px;border-top:1px solid #969696;border-bottom:1px solid #969696}th{background-color:#f9f9f9}.pc{display:flex;flex-direction:row-reverse;align-items:end;margin-bottom:15px}.pc .msg-container{margin-right:10px}.pc .msg-content{background-color:#F9CEDC;color:#333;padding:8px 12px;border-radius:16px 16px 4px 16px;font-size:15px;font-weight:400}.pc .msg-content em{color:#969696}.msg-timestamp{font-size:12px;color:#888;margin-top:4px;align-self:flex-end}` },
            black: { css: `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap');body{font-family:'Noto Sans TC','Helvetica Neue',Arial,sans-serif;line-height:1.6;margin:0;padding:0;background-color:#131217;color:#838287}.chat-container{max-width:500px;margin:0 auto;padding:10px}.environment{color:#77767B;padding:24px 8px;margin:0;text-align:center;font-size:16px;line-height:28px;font-weight:400}.environment .stars{display:block}.date-divider{font-size:12px;color:#77767B;text-align:center;margin:10px 0}.char{display:flex;align-items:flex-start;margin-bottom:15px}.avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0;background-size:cover;background-position:center;background-repeat:no-repeat}.msg-container{display:flex;flex-direction:column;max-width:--MSG-WIDTH--px;margin:0 10px}.character-name{font-size:14px;margin-bottom:4px;color:#F4F4F4}.char .msg-content{background-color:#312F3A;color:#E3E2E6;padding:8px 12px;border-radius:4px 16px 16px 16px;font-size:15px;font-weight:400}.char .msg-content em{color:#959499}blockquote{border-left:3px solid #959499;padding-left:.5em;margin:0}table{width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid #959499;margin:10px 0}th,td{text-align:left;padding:8px;border-top:1px solid #959499;border-bottom:1px solid #959499}th{background-color:#312F3A}.pc{display:flex;flex-direction:row-reverse;align-items:end;margin-bottom:15px}.pc .msg-container{margin-right:10px}.pc .msg-content{background-color:#4C4B50;color:#CFCFCE;padding:8px 12px;border-radius:16px 16px 4px 16px;font-size:15px;font-weight:400}.pc .msg-content em{color:#959499}.msg-timestamp{font-size:12px;color:#F4F4F4;margin-top:4px;align-self:flex-end}` },
            brown: { css: `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap');body{font-family:'Noto Sans TC','Helvetica Neue',Arial,sans-serif;line-height:1.6;margin:0;padding:0;background-color:#493F3E;color:#fff}.chat-container{max-width:500px;margin:0 auto;padding:10px}.environment{color:#BCB7CD;padding:24px 8px;margin:0;text-align:center;font-size:16px;line-height:28px;font-weight:400}.environment .stars{display:block}.date-divider{font-size:12px;color:#d7ccc8;text-align:center;margin:10px 0}.char{display:flex;align-items:flex-start;margin-bottom:15px}.avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0;background-size:cover;background-position:center;background-repeat:no-repeat}.msg-container{display:flex;flex-direction:column;max-width:--MSG-WIDTH--px;margin:0 10px}.character-name{font-size:14px;margin-bottom:4px;color:#BCB7CD}.char .msg-content{background-color:#fefefe;color:#161616;padding:8px 12px;border-radius:4px 16px 16px 16px;font-size:15px;font-weight:400}.char .msg-content em{color:#BCB7CD}blockquote{border-left:3px solid #BCB7CD;padding-left:.5em;margin:0}table{width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid #BCB7CD;margin:10px 0}th,td{text-align:left;padding:8px;border-top:1px solid #BCB7CD;border-bottom:1px solid #BCB7CD}th{background-color:#5A4F4E;color:#fff}.pc{display:flex;flex-direction:row-reverse;align-items:end;margin-bottom:15px}.pc .msg-container{margin-right:10px}.pc .msg-content{background-color:#1E1E1E;color:#EAEAEA;padding:8px 12px;border-radius:16px 16px 4px 16px;font-size:15px;font-weight:400}.pc .msg-content em{color:#BCB7CD}.msg-timestamp{font-size:12px;color:#d7ccc8;margin-top:4px;align-self:flex-end}` },
            green: { css: `@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap');body{font-family:'Noto Sans TC','Helvetica Neue',Arial,sans-serif;line-height:1.6;margin:0;padding:0;background-color:#f8f8f8;color:#333}.chat-container{max-width:500px;margin:0 auto;padding:10px}.environment{color:#87847d;padding:24px 8px;margin:0;text-align:center;font-size:16px;line-height:28px;font-weight:400}.environment .stars{display:block}.date-divider{font-size:12px;color:#87847d;text-align:center;margin:10px 0}.char{display:flex;align-items:flex-start;margin-bottom:15px}.avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0;background-size:cover;background-position:center;background-repeat:no-repeat}.msg-container{display:flex;flex-direction:column;max-width:--MSG-WIDTH--px;margin:0 10px}.character-name{font-size:14px;margin-bottom:4px;color:#87847d}.char .msg-content{background-color:#fefefe;color:#333;padding:8px 12px;border-radius:4px 16px 16px 16px;font-size:15px;font-weight:400}.char .msg-content em{color:#87847d}blockquote{border-left:3px solid #87847d;padding-left:.5em;margin:0}table{width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid #87847d;margin:10px 0}th,td{text-align:left;padding:8px;border-top:1px solid #87847d;border-bottom:1px solid #87847d}th{background-color:#e8f5e9}.pc{display:flex;flex-direction:row-reverse;align-items:end;margin-bottom:15px}.pc .msg-container{margin-right:10px}.pc .msg-content{background-color:#C9E8CE;color:#333;padding:8px 12px;border-radius:16px 16px 4px 16px;font-size:15px;font-weight:400}.pc .msg-content em{color:#87847d}.msg-timestamp{font-size:12px;color:#87847d;margin-top:4px;align-self:flex-end}` }
        };

        document.getElementById('charAvatar').style.backgroundImage = `url('${defaultAvatar}')`;
        document.getElementById('pcAvatar').style.backgroundImage = `url('${defaultAvatar}')`;

        function parseFileContent(content) {
            let date = "", character = "";
            const headerMatch = content.match(/={10,}\s*\n(.+?)(?:\s*-\s*.*)?\n.*?(\d{4}[./-]\d{2}[./-]\d{2})/s) || 
                                content.match(/={10,}\n(.+) - (.+)\n/); 
            if (headerMatch) {
                character = headerMatch[1].trim();
                const dateMatch = content.match(/\[(\d{4}-\d{2}-\d{2})/);
                date = dateMatch ? dateMatch[1] : "";
            } else {
                const dateMatch = content.match(/Date: (.+)/);
                const charMatch = content.match(/Character: (.+)/);
                date = dateMatch ? dateMatch[1] : "";
                character = charMatch ? charMatch[1] : "";
            }
            const regex = /\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\] ([^:]+?): ([\s\S]*?)(?=\n\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\]|$)/g;
            const messages = [];
            let match;
            while ((match = regex.exec(content)) !== null) {
                const timestamp = match[1], sender = match[2], messageContent = match[3].trim();
                if (sender.startsWith("Scene (")) continue;
                let type = sender === "Environment (system)" ? "environment" : sender === character ? "characterA" : "characterB";
                messages.push({ type, timestamp, sender: sender === "Environment (system)" ? "Environment" : sender, content: messageContent });
            }
            return { date, character, messages };
        }

        function formatContent(text) {
            let content = text;
            content = content.replace(/\|(.+\|)+\n\|([\s-]+\|)+(\n\|(.+\|)+)+/g, (tableStr) => {
                const lines = tableStr.trim().split("\n");
                if (lines.length < 2) return tableStr;
                const rows = lines.map((line, idx) => {
                    const cells = line.trim().replace(/^\||\|$/g, "").split("|").map(c => c.trim());
                    if (line.includes("---")) return "";
                    const tag = idx === 0 ? "th" : "td";
                    const cellsHtml = cells.map(c => `<${tag}>${c}</${tag}>`).join("");
                    return `<tr>${cellsHtml}</tr>`;
                }).filter(r => r !== "");
                return `<table><tbody>${rows.join("")}</tbody></table>`;
            });
            let inBlockquote = false, blockquoteText = "";
            const lines = content.split("\n"), result = [];
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i], quoteMatch = line.match(/^\s*>\s*(.*)/);
                if (line.match(/^\s*(\*\*\*|---)\s*$/)) {
                    if (inBlockquote) { result.push(`<blockquote>${blockquoteText}</blockquote>`); inBlockquote = false; blockquoteText = ""; }
                    result.push("<hr>"); continue;
                }
                if (quoteMatch) {
                    inBlockquote ? blockquoteText += "\n" + quoteMatch[1] : (inBlockquote = true, blockquoteText = quoteMatch[1]);
                    const nextLine = i < lines.length - 1 ? lines[i + 1] : null;
                    const isEmpty = nextLine && nextLine.trim() === "", isHr = nextLine && nextLine.match(/^\s*(\*\*\*|---)\s*$/);
                    if (i === lines.length - 1 || isEmpty || isHr) { result.push(`<blockquote>${blockquoteText}</blockquote>`); inBlockquote = false; blockquoteText = ""; }
                } else {
                    if (inBlockquote) {
                        if (line.trim() === "") { result.push(`<blockquote>${blockquoteText}</blockquote>`); result.push(""); inBlockquote = false; blockquoteText = ""; }
                        else blockquoteText += "\n" + line;
                    } else result.push(line);
                }
            }
            if (inBlockquote) result.push(`<blockquote>${blockquoteText}</blockquote>`);
            content = result.join("\n");
            content = content.replace(/<blockquote>([\s\S]*?)<\/blockquote>/g, (m, i) => {
                i = i.replace(/~~(.*?)~~/g, "<del>$1</del>").replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>").replace(/\*(.*?)\*/g, "<em>$1</em>");
                return `<blockquote>${i}</blockquote>`;
            });
            return content.replace(/~~(.*?)~~/g, "<del>$1</del>").replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>").replace(/\*(.*?)\*/g, "<em>$1</em>").replace(/<\/blockquote>\n/g, "</blockquote>").replace(/\n/g, "<br>");
        }

        function generateChatHTML(data, limit = null) {
            if (!data) data = parseFileContent(`Date: 2025-05-02\nCharacter: 志勳\n[2025-05-02 22:32:26] Environment (system): 晚上十點，辦公桌一片狼藉，咖啡杯空了，瀏覽器開了七十幾個分頁。螢幕上是對話記錄，一行行純文字讓工程師臉色死灰。\n\n[2025-05-02 22:32:26] 志勳: 「這就是你說的格式美化？」\n*他語氣平靜卻藏著壓力，站在螢幕前俯視你，像在審視一場災難現場*\n\n「給我一句話，這東西——要怎麼用？」\n\n[2025-05-02 22:34:31] 工程師: *長嘆一聲，邊敲鍵盤邊說：*「打開網頁，先上傳 txt 檔案，選你喜歡的顏色，再補角色跟玩家的頭像⋯⋯」\n\n*語氣逐漸崩潰*\n「如果轉換失敗，那就是卿卿我我官方偷偷更新 txt 格式啦 QAQ！！」\n`);
            let html = '<div class="chat-container">', lastDate = "";
            const msgs = limit ? data.messages.slice(0, limit) : data.messages;
            msgs.forEach(m => {
                const d = m.timestamp.split(" ")[0];
                if (d !== lastDate) { html += `\n<div class="date-divider">${d}</div>\n`; lastDate = d; }
                if (m.type === "environment") html += `\n<div class="environment">\n<span class="stars">***</span>\n${formatContent(m.content)}\n<span class="stars">***</span>\n</div>\n`;
                else if (m.type === "characterA") html += `\n<div class="char">\n<div class="avatar ava-char"></div>\n<div class="msg-container">\n<div class="character-name">${data.character}</div>\n<div class="msg-content">${formatContent(m.content)}</div>\n</div>\n<div class="msg-timestamp">${m.timestamp.split(" ")[1].substring(0,5)}</div>\n</div>\n`;
                else if (m.type === "characterB") html += `\n<div class="pc">\n<div class="avatar ava-pc"></div>\n<div class="msg-container">\n<div class="msg-content">${formatContent(m.content)}</div>\n</div>\n<div class="msg-timestamp">${m.timestamp.split(" ")[1].substring(0,5)}</div>\n</div>\n`;
            });
            return html + "</div>";
        }

        function generateFullHTML(theme, charAvatar, pcAvatar, data, width) {
            const title = data && data.character && data.date ? `${data.character} - ${data.date}` : "聊天記錄";
            const css = theme.css.replace('--MSG-WIDTH--', width);
            return `<!DOCTYPE html>\n<html>\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>${title}</title>\n<style>\n${css}\n.ava-char{background-image:url('${charAvatar}')}\n.ava-pc{background-image:url('${pcAvatar}')}\n</style>\n</head>\n<body>\n${generateChatHTML(data)}\n</body>\n</html>`;
        }


function updatePreview() {
            const theme = themes[document.getElementById('themeSelect').value];
            const previewData = parsedData ? {...parsedData, messages: parsedData.messages.slice(0, 40)} : null;
            const css = theme.css.replace('--MSG-WIDTH--', msgWidth);
            const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
${css}
.ava-char{background-image:url('${charAvatarData}')}
.ava-pc{background-image:url('${pcAvatarData}')}
</style>
</head>
<body>
${generateChatHTML(previewData)}
</body>
</html>`;
            document.getElementById('previewFrame').srcdoc = html;
        }

// 文件上傳處理
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        uploadedFile = file;
        document.getElementById('uploadText').textContent = file.name;
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result.replace(/^\uFEFF/, '');
            console.log('檔案長度:', text.length);
            console.log('前200字:', text.substring(0, 200));
            parsedData = parseFileContent(text);
            console.log('解析結果:', parsedData);
            
            if (!parsedData.messages.length) {
                alert('檔案已讀取，但格式與目前解析規則不完全相容');
            }
            updatePreview();
        };
        
        reader.readAsText(file, 'UTF-8');
    }
});

// 頭像上傳處理
document.getElementById('charAvatarInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            charAvatarData = e.target.result;
            document.getElementById('charAvatar').style.backgroundImage = `url('${charAvatarData}')`;
            updatePreview();
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('pcAvatarInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            pcAvatarData = e.target.result;
            document.getElementById('pcAvatar').style.backgroundImage = `url('${pcAvatarData}')`;
            updatePreview();
        };
        reader.readAsDataURL(file);
    }
});

// 主題切換
document.getElementById('themeSelect').addEventListener('change', updatePreview);

// 寬度調整
document.getElementById('widthSlider').addEventListener('input', function(e) {
    msgWidth = parseInt(e.target.value);
    updatePreview();
});

// 下載按鈕
document.getElementById('downloadBtn').addEventListener('click', function() {
    if (!parsedData) {
        alert('請先上傳 TXT 文件');
        return;
    }
    const theme = themes[document.getElementById('themeSelect').value];
    const html = generateFullHTML(theme, charAvatarData, pcAvatarData, parsedData, msgWidth);
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    let filename = uploadedFile ? uploadedFile.name.replace(/\.txt$/, '') : 'chat';
    if (parsedData.character && parsedData.date) {
        filename = `${parsedData.character}_${parsedData.date}`;
    }
    a.download = `${filename}.html`;
    a.href = url;
    a.click();
    URL.revokeObjectURL(url);
});

// 初始化預覽
updatePreview();
    </script>
</body>
</html>
