<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç¹ç°¡èˆ‡æ¨™é»å…¨è‡ªå‹•è½‰æ›å™¨ï¼ˆLOFTER API ç‰ˆï¼‰</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

/* ---------------- Icons ---------------- */
const IconType = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-600"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>
);
const IconRefreshCw = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>
);
const IconTrash2 = () => (
  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mr-1"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
);
const IconCopy = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
);
const IconCheck = ({ className }) => (
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"></polyline></svg>
);

/* ---------------- ä¸»ç¨‹å¼ ---------------- */
function App() {
    const [inputText, setInputText] = useState('');
    const [outputText, setOutputText] = useState('');
    const [isCopied, setIsCopied] = useState(false);
    const [converterReady, setConverterReady] = useState(false);
    const [urlInput, setUrlInput] = useState('');
    const openccRef = useRef(null);

    /* ----------- åˆå§‹åŒ– OpenCC ----------- */
    useEffect(() => {
        const initConverter = () => {
            if (window.OpenCC) {
                try {
                    openccRef.current = window.OpenCC.Converter({ from: 'cn', to: 'tw' });
                    setConverterReady(true);
                } catch (e) {
                    console.error("OpenCC init error:", e);
                }
            } else {
                setTimeout(initConverter, 300);
            }
        };
        initConverter();
    }, []);

    /* ----------- æ¨™é»å…¨å½¢åŒ– ----------- */
    const convertPunctuation = text => {
        const map = {
            ',':'ï¼Œ','.':'ã€‚','?':'ï¼Ÿ','!':'ï¼',':':'ï¼š',';':'ï¼›','(':'ï¼ˆ',')':'ï¼‰','[':'ã€',']':'ã€‘','{':'ï½›','}':'ï½','<':'ã€Š','>':'ã€‹','/':'ï¼','\\':'ï¼¼','|':'ï½œ','@':'ï¼ ','#':'ï¼ƒ','$':'ï¼„','%':'ï¼…','^':'ï¸¿','&':'ï¼†','_':'ï¼¿','+':'ï¼‹','-':'ï¼','=':'ï¼','~':'ï½','`':'â€µ','"':'ã€Œ','"':'ã€'
        };
        return text.replace(/[,.?!:;()\[\]{}<>\/\\|@#$%^&_+\-=~`"\"]/g, m => map[m] || m);
    };

    /* ----------- ä¸»è½‰æ›æµç¨‹ ----------- */
    const handleConvert = text => {
        let t = text;
        if (converterReady && openccRef.current) t = openccRef.current(t);
        t = convertPunctuation(t);
        t = t.replace(/\n{2,}/g, '\n');
        setOutputText(t);
    };

    /* ----------- æ”¹å‹•é‡é»ï¼šä½¿ç”¨ Proxy ä»¥ç¹é CORS é˜»æ“‹ ----------- */
    async function fetchWithProxies(url) {
        const proxies = [
            "https://corsproxy.io/?",
            "https://api.allorigins.win/raw?url=",
            "https://api.codetabs.com/v1/proxy?quest="
        ];
        let lastError = null;
        for (const p of proxies) {
            try {
                const full = p + encodeURIComponent(url);
                const r = await fetch(full);
                if (r.ok) return r;
            } catch (e) {
                lastError = e;
            }
        }
        throw new Error("æ‰€æœ‰ä»£ç†ç„¡æ³•å–å¾—è³‡æ–™ï¼Œæœ€å¾ŒéŒ¯èª¤ï¼š" + (lastError && lastError.message ? lastError.message : "æœªçŸ¥éŒ¯èª¤"));
    }

    /* ----------- LOFTER API æŠ“å–æ–‡ç« ï¼ˆæ”¹ç‚ºé€é fetchWithProxiesï¼‰ ----------- */
    async function fetchLofterArticle(urlInput) {
        const match = urlInput.match(/https:\/\/(.+?)\.lofter\.com\/post\/(\w+)/);
        if (!match) throw new Error("ç¶²å€æ ¼å¼éŒ¯èª¤ï¼ˆéœ€è¦ user.lofter.com/post/xxxxï¼‰");

        const user = match[1];
        const postId = match[2];
        const apiUrl = `https://api.lofter.com/v2.0/blog/${user}/post/${postId}`;

        // ä½¿ç”¨ä»£ç†è¼ªè©¢ï¼Œé¿å… CORS é˜»æ“‹
        const res = await fetchWithProxies(apiUrl);
        if (!res || !res.ok) throw new Error("Failed to fetchï¼ˆå¯èƒ½è¢« CORS é˜»æ“‹æˆ–ä»£ç†å¤±æ•—ï¼‰");

        const data = await res.json();
        if (!data.posts || !data.posts.length) throw new Error("æ‰¾ä¸åˆ°æ–‡ç« å…§å®¹");

        const html = data.posts[0].content;
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, "text/html");
        const ps = Array.from(doc.querySelectorAll("p"));

        let text = ps.map(p => {
            let t = p.innerHTML.replace(/<br\s*\/?>/gi, "\n");
            const d = document.createElement("div");
            d.innerHTML = t;
            return d.textContent.trim();
        }).filter(t => t.length > 0).join("\n");

        return text.trim();
    }

    /* ----------- æŠ“æ–‡ç« æŒ‰éˆ•äº‹ä»¶ ----------- */
    const fetchHandler = async () => {
        if (!urlInput) return;

        const msg = document.createElement('div');
        msg.textContent = 'æ­£åœ¨æŠ“å– LOFTER æ–‡ç« ...';
        msg.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#3b82f6;color:white;padding:12px 24px;border-radius:8px;z-index:9999;';
        document.body.appendChild(msg);

        try {
            const t = await fetchLofterArticle(urlInput);
            msg.remove();
            setInputText(t);
            handleConvert(t);
        } catch (err) {
            msg.remove();
            alert("æŠ“å–å¤±æ•—ï¼š" + err.message);
        }
    };

    /* ----------- æ¸…ç©º ----------- */
    const handleClear = () => { setInputText(''); setOutputText(''); };

    /* ----------- è¼¸å…¥å€äº‹ä»¶ ----------- */
    const handleInputChange = e => {
        const t = e.target.value;
        setInputText(t);
        handleConvert(t);
    };

    /* ----------- è¤‡è£½ ----------- */
    const handleCopy = () => {
        if (!outputText) return;
        navigator.clipboard.writeText(outputText).then(() => {
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 1500);
        });
    };

    return (
        <>
        <div className="min-h-screen p-4 md:p-8 font-sans text-slate-800 overflow-auto">
            <div className="max-w-3xl mx-auto space-y-6">
                <div className="text-center space-y-2">
                    <h1 className="text-2xl md:text-3xl font-bold text-slate-900 flex items-center justify-center gap-2">
                        <IconType /> ç¹ç°¡èˆ‡æ¨™é»å…¨è‡ªå‹•è½‰æ›å™¨ï¼ˆLOFTER APIï¼‰
                    </h1>
                    <p className="text-slate-500 text-sm">
                        è‡ªå‹•å°‡ LOFTER API æŠ“å–æ–‡ç«  â†’ ç°¡è½‰ç¹ â†’ å…¨å½¢æ¨™é»
                    </p>
                </div>

                {/* URL + æŠ“æ­£æ–‡ */}
                <div className="space-y-2 mb-4">
                    <div className="flex gap-2">
                        <input
                            type="text"
                            placeholder="è²¼ä¸Š LOFTER æ–‡ç« ç¶²å€..."
                            value={urlInput}
                            onChange={e => setUrlInput(e.target.value)}
                            className="flex-1 p-2 border rounded-md text-sm"
                        />

                        <button
                            onClick={fetchHandler}
                            className="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition"
                        >ğŸ“¥ æŠ“æ­£æ–‡</button>
                    </div>
                    <p className="text-xs text-slate-500 px-1">æ”¯æ´ LOFTER æ–‡ç« è‡ªå‹•æŠ“å–ï¼ˆè‹¥å¤±æ•—è«‹åƒè€ƒä¸‹æ–¹å‚™è¨»ï¼‰</p>
                </div>

                {/* è¼¸å…¥æ¡† */}
                <div className="flex flex-col bg-white rounded-xl shadow-sm border border-slate-200">
                    <div className="flex justify-between items-center px-4 py-2 bg-slate-100 border-b border-slate-200">
                        <label className="text-sm font-semibold text-slate-600">è¼¸å…¥æ–‡å­—</label>
                        {inputText && (
                            <button onClick={handleClear} className="text-xs flex items-center text-slate-400 hover:text-red-500 transition-colors"><IconTrash2 /> æ¸…ç©º</button>
                        )}
                    </div>
                    <textarea
                        className="flex-1 p-4 resize-none outline-none text-base leading-relaxed"
                        placeholder="è²¼ä¸Šæˆ–æŠ“å– LOFTER å…§å®¹..."
                        value={inputText}
                        onChange={handleInputChange}
                        spellCheck="false"
                    />
                </div>

                {/* è¤‡è£½æŒ‰éˆ• */}
                <div className="flex justify-end mb-2">
                    <button
                        onClick={handleCopy}
                        disabled={!outputText}
                        className={`px-4 py-2 rounded-lg text-sm font-semibold shadow transition ${!outputText ? 'opacity-50 cursor-not-allowed bg-gray-200' : isCopied ? 'bg-green-500 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                    >{isCopied ? 'âœ” å·²è¤‡è£½' : 'ğŸ“‹ è¤‡è£½å…§å®¹'}</button>
                </div>

                {/* è¼¸å‡ºå€ */}
                <div className="relative flex flex-col bg-white rounded-xl border border-blue-200 overflow-visible">
                    <div className="flex justify-between items-center px-4 py-2 bg-blue-50 border-b border-blue-100">
                        <label className="text-sm font-semibold text-blue-800">è½‰æ›çµæœï¼ˆç¹é«” + å…¨å½¢æ¨™é»ï¼‰</label>
                    </div>
                    <div className="p-4 text-base leading-relaxed text-slate-800 whitespace-pre-wrap">{outputText}</div>
                </div>
            </div>
        </div>
        </>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>

</body>
</html>
