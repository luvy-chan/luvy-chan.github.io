<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拉比的工具箱</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
            min-height: 100vh;
            padding: 24px;
        }

        .max-w-4xl {
            max-width: 896px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 32px;
            text-align: center;
        }

        header h1 {
            font-size: 1.875rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        header p {
            color: #4b5563;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        @media (min-width: 768px) {
            .grid {
                grid-template-columns: 1fr 2fr;
            }
        }

        .card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: border-color 0.2s;
        }

        .upload-area:hover {
            border-color: #3b82f6;
        }

        .upload-area svg {
            width: 32px;
            height: 32px;
            color: #9ca3af;
            margin-bottom: 8px;
        }

        .upload-area p {
            font-size: 0.75rem;
            color: #4b5563;
        }

        input[type="file"] {
            display: none;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .avatar-preview {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 1px solid #d1d5db;
            background-size: cover;
            background-position: center;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZTBlMGUwIiBkPSJNMjU2IDUxMmMxNDEuNCAwIDI1Ni0xMTQuNiAyNTYtMjU2UzM5Ny40IDAgMjU2IDBTMCAxMTQuNiAwIDI1NnMxMTQuNiAyNTYgMjU2IDI1NnoiLz48cGF0aCBmaWxsPSIjYWFhIiBkPSJNMjU2IDI4OGMtNTMgMC05Ni00My05Ni05NnM0My05NiA5Ni05NnM5NiA0MyA5NiA5Ni00MyA5Ni05NiA5NnptMCAxMjhjLTEwNSAwLTE5Mi03MS0xOTItMTU5LjggMC0zMC4yIDEwLjgtNTguNyAzMC40LTgxLjZDMTI2LjIgMTM3LjE4IDE4Ny44IDExMiAyNTYgMTEyczEyOS44IDI1LjE4IDE2MS42IDYyLjZjMTkuNiAyMi45IDMwLjQgNTEuNCAzMC40IDgxLjZDNDQ4IDM0NSAzNjEgNDE2IDI1NiA0MTZ6Ii8+PC9zdmc+');
        }

        .btn-upload {
            padding: 4px 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-upload:hover {
            background: #2563eb;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider-container span {
            font-size: 0.75rem;
            color: #6b7280;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            outline: none;
            padding: 0;
        }

        .btn-download {
            width: 100%;
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-download:hover {
            background: #2563eb;
        }

        .preview-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .browser-bar {
            background: #f3f4f6;
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            gap: 4px;
        }

        .browser-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .browser-dot:nth-child(1) { background: #ef4444; }
        .browser-dot:nth-child(2) { background: #eab308; }
        .browser-dot:nth-child(3) { background: #22c55e; }

        .preview-frame {
            width: 100%;
            height: 685px;
            border: none;
            background: white;
        }

        .preview-hint {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        footer {
            margin-top: 48px;
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .space-y-4 > * + * {
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="max-w-4xl">
        <header>
            <h1>拉比的工具箱</h1>
            <p>上傳文字檔案，套用樣式，轉換為美化 HTML</p>
        </header>

        <div class="grid">
            <!-- Left Column -->
            <div style="display: flex; flex-direction: column; gap: 24px;">
                <!-- Upload Section -->
                <div class="card">
                    <h2>上傳文件</h2>
                    <div class="upload-area" id="uploadArea">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p>點擊以選取 .txt 文件</p>
                        <input type="file" id="fileInput" accept=".txt">
                    </div>
                </div>

                <!-- Theme Selection -->
                <div class="card">
                    <h2>選擇聊天室主題</h2>
                    <select id="themeSelect">
                        <option value="basic">基礎</option>
                        <option value="black">黑色</option>
                        <option value="brown">棕色</option>
                        <option value="green">綠色</option>
                    </select>
                </div>

                <!-- Avatar Selection -->
                <div class="card">
                    <h2>選擇頭像</h2>
                    <div class="space-y-4">
                        <div>
                            <label>角色 頭像</label>
                            <div class="avatar-upload">
                                <div class="avatar-preview" id="charAvatar"></div>
                                <button class="btn-upload" onclick="document.getElementById('charAvatarInput').click()">上傳圖片</button>
                                <input type="file" id="charAvatarInput" accept="image/*">
                            </div>
                        </div>
                        <div>
                            <label>玩家 頭像</label>
                            <div class="avatar-upload">
                                <div class="avatar-preview" id="pcAvatar"></div>
                                <button class="btn-upload" onclick="document.getElementById('pcAvatarInput').click()">上傳圖片</button>
                                <input type="file" id="pcAvatarInput" accept="image/*">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Width Adjustment -->
                <div class="card">
                    <h2>調整訊息寬度</h2>
                    <div class="slider-container">
                        <span>280px</span>
                        <input type="range" id="widthSlider" min="280" max="400" step="15" value="280">
                        <span>400px</span>
                    </div>
                </div>

                <!-- Download Button -->
                <div class="card">
                    <button class="btn-download" id="downloadBtn">下載 HTML 文件</button>
                </div>
            </div>

            <!-- Right Column - Preview -->
            <div class="card">
                <h2>預覽</h2>
                <p class="preview-hint">（預覽畫面僅顯示前 40 則訊息，可滾動查看內容）</p>
                <div class="preview-container">
                    <div class="browser-bar">
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                        <div class="browser-dot"></div>
                    </div>
                    <iframe id="previewFrame" class="preview-frame"></iframe>
                </div>
            </div>
        </div>

        <footer>
            <p>拉比的工具箱 © 2025</p>
        </footer>
    </div>

    <script>
        let messages = [];
        let charAvatarData = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZTBlMGUwIiBkPSJNMjU2IDUxMmMxNDEuNCAwIDI1Ni0xMTQuNiAyNTYtMjU2UzM5Ny40IDAgMjU2IDBTMCAxMTQuNiAwIDI1NnMxMTQuNiAyNTYgMjU2IDI1NnoiLz48cGF0aCBmaWxsPSIjYWFhIiBkPSJNMjU2IDI4OGMtNTMgMC05Ni00My05Ni05NnM0My05NiA5Ni05NnM5NiA0MyA5NiA5Ni00MyA5Ni05NiA5NnptMCAxMjhjLTEwNSAwLTE5Mi03MS0xOTItMTU5LjggMC0zMC4yIDEwLjgtNTguNyAzMC40LTgxLjZDMTI2LjIgMTM3LjE4IDE4Ny44IDExMiAyNTYgMTEyczEyOS44IDI1LjE4IDE2MS42IDYyLjZjMTkuNiAyMi45IDMwLjQgNTEuNCAzMC40IDgxLjZDNDQ4IDM0NSAzNjEgNDE2IDI1NiA0MTZ6Ii8+PC9zdmc+";
        let pcAvatarData = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cGF0aCBmaWxsPSIjZTBlMGUwIiBkPSJNMjU2IDUxMmMxNDEuNCAwIDI1Ni0xMTQuNiAyNTYtMjU2UzM5Ny40IDAgMjU2IDBTMCAxMTQuNiAwIDI1NnMxMTQuNiAyNTYgMjU2IDI1NnoiLz48cGF0aCBmaWxsPSIjYWFhIiBkPSJNMjU2IDI4OGMtNTMgMC05Ni00My05Ni05NnM0My05NiA5Ni05NnM5NiA0MyA5NiA5Ni00MyA5Ni05NiA5NnptMCAxMjhjLTEwNSAwLTE5Mi03MS0xOTItMTU5LjggMC0zMC4yIDEwLjgtNTguNyAzMC40LTgxLjZDMTI2LjIgMTM3LjE4IDE4Ny44IDExMiAyNTYgMTEyczEyOS44IDI1LjE4IDE2MS42IDYyLjZjMTkuNiAyMi45IDMwLjQgNTEuNCAzMC40IDgxLjZDNDQ4IDM0NSAzNjEgNDE2IDI1NiA0MTZ6Ii8+PC9zdmc+";
        let msgWidth = 280;

        const themes = {
            basic: { bg: '#FFF5F8', charBg: '#FFFFFF', pcBg: '#F9CEDC' },
            black: { bg: '#2C2C2C', charBg: '#3A3A3A', pcBg: '#4A4A4A' },
            brown: { bg: '#F5E6D3', charBg: '#FFFFFF', pcBg: '#E8D4B8' },
            green: { bg: '#E8F5E9', charBg: '#FFFFFF', pcBg: '#C8E6C9' }
        };

        // Upload handling
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseFile(e.target.result);
                };
                reader.readAsText(file, 'UTF-8');
            }
        });

        // Avatar uploads
        document.getElementById('charAvatarInput').addEventListener('change', function(e) {
            handleAvatarUpload(e, 'charAvatar', 'char');
        });

        document.getElementById('pcAvatarInput').addEventListener('change', function(e) {
            handleAvatarUpload(e, 'pcAvatar', 'pc');
        });

        function handleAvatarUpload(e, previewId, type) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = e.target.result;
                    document.getElementById(previewId).style.backgroundImage = `url('${data}')`;
                    if (type === 'char') charAvatarData = data;
                    else pcAvatarData = data;
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        // Width slider
        document.getElementById('widthSlider').addEventListener('input', function(e) {
            msgWidth = e.target.value;
            updatePreview();
        });

        // Theme change
        document.getElementById('themeSelect').addEventListener('change', updatePreview);

        function parseFile(content) {
            const lines = content.split('\n');
            messages = [];
            let currentDate = '';
            
            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                // Date divider: YYYY-MM-DD or similar
                if (line.match(/^\d{4}[-/]\d{2}[-/]\d{2}$/)) {
                    messages.push({ type: 'date', content: line });
                    currentDate = line;
                }
                // Environment: ***text***
                else if (line.startsWith('***') && line.endsWith('***')) {
                    const env = line.slice(3, -3).trim();
                    if (env) messages.push({ type: 'environment', content: env });
                    else messages.push({ type: 'stars' });
                }
                // Message: [time] name: content
                else {
                    const match = line.match(/^\[([^\]]+)\]\s*([^:]+):\s*(.+)$/);
                    if (match) {
                        messages.push({
                            type: 'message',
                            time: match[1],
                            name: match[2].trim(),
                            content: match[3].trim()
                        });
                    }
                }
            }
            
            updatePreview();
        }

        function updatePreview() {
            const html = generateHTML(true);
            const frame = document.getElementById('previewFrame');
            frame.srcdoc = html;
        }

        function generateHTML(preview = false) {
            const theme = themes[document.getElementById('themeSelect').value];
            const displayMessages = preview ? messages.slice(0, 40) : messages;
            
            let htmlContent = '';
            
            displayMessages.forEach(msg => {
                if (msg.type === 'date') {
                    htmlContent += `<div class="date-divider">${escapeHtml(msg.content)}</div>\n`;
                } else if (msg.type === 'environment') {
                    htmlContent += `<div class="environment"><span class="stars">***</span>\n${escapeHtml(msg.content)}\n<span class="stars">***</span></div>\n`;
                } else if (msg.type === 'stars') {
                    htmlContent += `<div class="environment"><span class="stars">***</span></div>\n`;
                } else if (msg.type === 'message') {
                    const isPC = msg.name.includes('玩家') || displayMessages.filter(m => m.type === 'message').indexOf(msg) % 2 === 1;
                    const className = isPC ? 'pc' : 'char';
                    const avatarClass = isPC ? 'ava-pc' : 'ava-char';
                    
                    htmlContent += `
      <div class="${className}">
        <div class="avatar ${avatarClass}"></div>
        <div class="msg-container">
          ${!isPC ? `<div class="character-name">${escapeHtml(msg.name)}</div>` : ''}
          <div class="msg-content">${escapeHtml(msg.content).replace(/\n/g, '<br>')}</div>
        </div>
        <div class="msg-timestamp">${escapeHtml(msg.time)}</div>
      </div>\n`;
                }
            });

            return `
    <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap');
          body{ font-family:'Noto Sans TC','Helvetica Neue',Arial,sans-serif;line-height:1.6;margin:0;padding:0;background-color:${theme.bg};color:#333333}
          .chat-container{ max-width:500px;margin:0 auto;padding:10px}
          .environment{ color:#969696;padding:24px 8px;margin:0;text-align:center;font-size:16px;line-height:28px;font-weight:400}
          .environment .stars{ display:block}
          .date-divider{ font-size:12px;color:#888888;text-align:center;margin:10px 0}
          .char{ display:flex;align-items:flex-start;margin-bottom:15px}
          .avatar{ width:40px;height:40px;border-radius:50%;overflow:hidden;flex-shrink:0;background-size:cover;background-position:center;background-repeat:no-repeat}
          .msg-container{ display:flex;flex-direction:column;max-width:${msgWidth}px;margin:0 10px}
          .character-name{ font-size:14px;margin-bottom:4px;color:#888888}
          .char .msg-content{ background-color:${theme.charBg};color:#333333;padding:8px 12px;border-radius:4px 16px 16px 16px;font-size:15px;font-weight:400}
          .char .msg-content em{ color:#969696}
          blockquote{ border-left:3px solid #969696;padding-left:0.5em;margin:0}
          table{ width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid #969696;margin:10px 0}
          th,td{ text-align:left;padding:8px;border-top:1px solid #969696;border-bottom:1px solid #969696}
          th{ background-color:#f9f9f9}
          .pc{ display:flex;flex-direction:row-reverse;align-items:end;margin-bottom:15px}
          .pc .msg-container{ margin-right:10px}
          .pc .msg-content{ background-color:${theme.pcBg};color:#333333;padding:8px 12px;border-radius:16px 16px 4px 16px;font-size:15px;font-weight:400}
          .pc .msg-content em{ color:#969696}
          .msg-timestamp{ font-size:12px;color:#888888;margin-top:4px;align-self:flex-end}
          .ava-char { background-image: url('${charAvatarData}'); }
          .ava-pc { background-image: url('${pcAvatarData}'); }
        </style>
      </head>
      <body>
        <div class="chat-container">
${htmlContent}
        </div>
      </body>
    </html>
  `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (messages.length === 0) {
                alert('請先上傳文字檔案');
                return;
            }
            
            const html = generateHTML(false);
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chat_conversation.html';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Load default preview
        updatePreview();
    </script>
</body>
</html>
